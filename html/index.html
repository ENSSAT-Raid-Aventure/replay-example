<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raid Aventure</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  </head>
  <body>
    <div class="container">
      <div class="row">
          <div id="map">

          </div>
        <div class="classement">
          <div class="col-lg-12">
            <h3>Classement</h3>
            <ul id="logsDiv">

            </ul>
          </div>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.12.0.min.js" charset="utf-8"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/script.js" charset="utf-8"></script>
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
        //Initialisation de la carte
        var map = new L.Map('map');
        var basemapLayer = new L.TileLayer('http://{s}.tiles.mapbox.com/v3/github.map-xgq2svrz/{z}/{x}/{y}.png');
        // Center map and default zoom level
        map.setView([48.734759, -3.538378 ], 14);
        // Adds the background layer to the map
        map.addLayer(basemapLayer);
        var socket = io.connect('/');
        var marker = [];
        var circuits = {
          confirme :{
            kayak : {},
            velo : {},
            running : {}
          },
          debutant : {
            kayak : {},
            velo : {},
            running : {}
          }
        }
        var circuits_name = { "kayak" : "kayak", "running" : "trail", "velo" : "vtt" }
        var polyline = "";
        var opacity_circuit = 0.5;
        var lat2 =  0;
        var lon2 = 0;
        var lat1 = 0;
        var lon1 = 0;
        var vitesse_moyenne = 0;
        var nb_valeur_vitesse = 0;
        var distance_parcouru = 0;
        //Gestion des socket
        var circuit = null;
        /*$.getJSON("/circuit.json",null,function(data){
          var LngLat = get_customGeometryJSON(data,"coordinates");
          $(LngLat).each(function(){
            this.reverse();
          })
          var polyline2 = L.polyline(LngLat, {color: '#ddd', opacity: 0.5, weight : 10}).addTo(map);
        });*/
        /*
        $.ajax({
          url : "/api/teams",
          type : "GET",
          success : function(datas){
            if(datas.length){
              $.ajax({
                url : "/first-coordinates",
                type : "GET",
                success : function(first_coordinates){
                  for(var index = 0; index < datas.length; index ++){
                    var marker_ = L.marker([ first_coordinates.data2[1] , first_coordinates.data2[0] ]).addTo(map);
                    marker.push({
                        marker : marker_,
                        team : datas[index].team,
                        dev_id : datas[index].dev_id
                    });
                  };
                  //marker = L.marker([ data.data2[1] , data.data2[0] ]).addTo(map);

                  polyline = L.polyline([], { color: 'red', opacity : 1, smoothFactor: 5, weight : 3}).addTo(map);
                  lat1 = data.data1[1];
                  lon1 = data.data1[0];
                  lat2 = data.data2[1];
                  lon2 = data.data2[0];
                  distance_parcouru += getDistanceLatLng(lat1,lon1,lat2,lon2);
                  var vitesse = getVitesseKmH(lat1,lon1,lat2,lon2,200);
                  vitesse_moyenne = (vitesse_moyenne * nb_valeur_vitesse + vitesse) / (nb_valeur_vitesse + 1);
                  nb_valeur_vitesse = 1;

                }
              });
            }
          }
        });*/
        $.ajax({
          url : "/api/circuits/true",
          type : "GET",
          success : function(datas){
            if(datas.length > 0){
              for(var index_circuit = 0; index_circuit < datas.length; index_circuit ++){
                switch (datas[index_circuit].properties.part) {
                  case circuits_name["kayak"]:
                    var circuit = _.map(datas[0].geometry.coordinates, function(coordonnees){
                      return new L.LatLng(coordonnees[1], coordonnees[0]);
                    });
                    circuits.confirme.kayak = new L.polyline(circuit , { color: datas[0].properties.color, opacity : opacity_circuit, smoothFactor: 5, weight : 3}).addTo(map);
                    break;
                  case circuits_name["velo"]:
                    var circuit = _.map(datas[0].geometry.coordinates, function(coordonnees){
                      return new L.LatLng(coordonnees[1], coordonnees[0]);
                    });
                    circuits.confirme.velo = new L.polyline(circuit , { color: datas[0].properties.color, opacity : opacity_circuit, smoothFactor: 5, weight : 3}).addTo(map);
                    break;
                  case circuits_name["running"]:
                    var circuit = _.map(datas[0].geometry.coordinates, function(coordonnees){
                      return new L.LatLng(coordonnees[1], coordonnees[0]);
                    });
                    circuits.confirme.running = new L.polyline(circuit , { color: datas[0].properties.color, opacity : opacity_circuit, smoothFactor: 5, weight : 3}).addTo(map);
                    break;
                }
              }
              $.ajax({
                url : "/api/teams",
                type : "GET",
                success : function(datas_){
                  var first_coordinates = [datas[0].geometry.coordinates[0][0], datas[0].geometry.coordinates[0][1]];
                  if(datas_.length){
                    for(var index = 0; index < datas_.length; index ++){
                      var marker_ = L.marker([ first_coordinates[1] , first_coordinates[0] ]).addTo(map);
                      marker.push({
                          marker : marker_,
                          team : datas_[index].team,
                          dev_id : datas_[index].dev_id
                      });
                    };
                  }
                }
              });
            }
          }
        });

        socket.on('classement-update',function(data){
          /*
          polyline.addLatLng([data[1], data[0]]);
          marker.setLatLng([data[1], data[0]]);
          lat1 = lat2;
          lon1 = lon2;
          lat2 = data[1];
          lon2 = data[0];
          distance_parcouru += getDistanceLatLng(lat1,lon1,lat2,lon2);
          var vitesse = getVitesseKmH(lat1,lon1,lat2,lon2,1000);
          vitesse_moyenne = (vitesse_moyenne * nb_valeur_vitesse + vitesse) / (nb_valeur_vitesse + 1);
          nb_valeur_vitesse ++;
          //logsDiv("Nouvelle position : " + data);
          logsDiv("Vitesse : " + vitesse_moyenne.toFixed(2) + " km/h");
          logsDiv("Distance parcourue : " + (distance_parcouru / 1000).toFixed(3) + " km");
          */
        });
        socket.on("update",function(data){
          console.log(data);
          var marker_ = _.find(marker, function(m){ return m.dev_id == data.dev_id});
          xxx = data.position;

          if(marker_)
            marker_.marker.setLatLng([data.position[1], data.position[0]]);
          //polyline.addLatLng([data[1], data[0]]);
          //marker.setLatLng([data[1], data[0]]);
          console.log(data.team);
          console.log(data.position);
        })
      });

      function logsDiv(message){
        var logs_div = document.getElementById("logsDiv");
        $(logs_div).prepend("<li>" + message + "</li>");
      }
    </script>
  </body>
</html>
